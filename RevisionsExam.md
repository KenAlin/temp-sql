# Révisions pour l'exam SQL
## Création de table
```sql
CREATE TABlE AUTEUR(
    NUM_AUTEUR  NUMBER(6),
    NOM         VARCHAR2(30),
    PRENOM      VARCHAR2(20),
    NATIONALITE VARCHAR2(30)
);
```

## Création de vue
* Simple vue dupliquant les emprunts :
```sql
CREATE OR REPLACE VIEW emprunts AS SELECT * FROM EMPRUNT;
```

## Création de procédure ou fonction
```sql
CREATE OR REPLACE PROCEDURE coucou (n number)
IS
BEGIN
    dbms_output.put_line('Bonjour ' || to_char(n));
END ;
/

--- Exemple déclenchement :
execute coucou(42);

--- Affiche :
"Bonjour 42"
```

* Création de fonction (doit renvoyer une valeur) :
```sql
CREATE FUNCTION ANNEEPLUS2 (nm VARCHAR2) RETURN NUMBER
IS
    annee number;
BEGIN
    SELECT annee_naissance into annee from Artiste WHERE nom_artiste = nm;
    return annee + 2 ;
END ;
/
```


## Création de trigger
```sql
CREATE OR REPLACE TRIGGER SET_DATE
BEFORE INSERT ON EMPRUNT
FOR EACH ROW
BEGIN
  :NEW.D_emprunt := sysdate;
  :NEW.D_RETOUR := SYSDATE+21;
END;
/
--- Exemple déclenchement :
INSERT INTO EMPRUNT (NUM_AB, NUM_EX) VALUES(931111, 2673);
```


```sql
CREATE OR REPLACE TRIGGER MAJ_RT1_1
AFTER INSERT ON EMPRUNT
FOR EACH ROW
BEGIN
  UPDATE RT1 R
  SET NB_EMPRUNT = NB_EMPRUNT+1
  WHERE R.ISBN = (SELECT EX.ISBN 
                  FROM EXEMPLAIRE EX 
                  WHERE EX.NUMERO = :NEW.NUM_EX);
END;
/

CREATE OR REPLACE TRIGGER MAJ_RT1_2
AFTER INSERT OR UPDATE ON EXEMPLAIRE
FOR EACH ROW
BEGIN
  UPDATE RT1 R
  SET EX_EMPRUNTABLE = EX_EMPRUNTABLE+1
  WHERE R.ISBN = :NEW.ISBN
  AND :NEW.CODE_PRET = 'EMPRUNTABLE'
  AND :OLD.CODE_PRET <> 'EMPRUNTABLE';
END;
/

CREATE OR REPLACE TRIGGER MAJ_RT1_3
AFTER UPDATE ON EXEMPLAIRE
FOR EACH ROW
BEGIN
  UPDATE RT1 R
  SET EX_EMPRUNTABLE = EX_EMPRUNTABLE-1
  WHERE R.ISBN = :NEW.ISBN
  AND :NEW.CODE_PRET <> 'EMPRUNTABLE'
  AND :OLD.CODE_PRET = 'EMPRUNTABLE';
END;
/
```


```sql
CREATE OR REPLACE TRIGGER PAS_EMPRUNT_SI_PAS_EMPRUNTABLE
BEFORE INSERT OR UPDATE ON EMPRUNT
FOR EACH ROW
DECLARE
  NOMBRE_NULL NUMBER;
  CP_N_EMPRUNTABLE EXCEPTION;
  DATE_RET_REEL_OLDER EXCEPTION;
  EX_EN_COURS_EMPRUNT EXCEPTION;
BEGIN
  SELECT COUNT(*) INTO NOMBRE_NULL
  FROM exemplaire ex
  WHERE :NEW.NUM_EX = numero
        AND code_pret != 'EMPRUNTABLE';
  IF NOMBRE_NULL <> 0 THEN
    RAISE CP_N_EMPRUNTABLE;
  END IF;
  
  IF :NEW.D_RET_REEL < :NEW.d_emprunt THEN
    RAISE DATE_RET_REEL_OLDER;
  END IF;
  
  SELECT COUNT(*) INTO NOMBRE_NULL
  FROM emprunts
  WHERE :NEW.NUM_EX = num_ex
        AND d_ret_reel is null
        AND num_ab != :NEW.num_ab;
  IF NOMBRE_NULL <> 0 THEN
    RAISE EX_EN_COURS_EMPRUNT;
  END IF;
  
  
EXCEPTION
  WHEN CP_N_EMPRUNTABLE THEN
  BEGIN
    DBMS_OUTPUT.PUT_LINE('IMPOSSIBLE !');
    RAISE_APPLICATION_ERROR(-20001, 'EXEMPLAIRE NON EMPRUNTABLE');
  END;
  WHEN DATE_RET_REEL_OLDER THEN
  BEGIN
    DBMS_OUTPUT.PUT_LINE('IMPOSSIBLE !');
    RAISE_APPLICATION_ERROR(-20001, 'FAILLE DANS L"ESPACE TEMPS');
  END;
  WHEN EX_EN_COURS_EMPRUNT THEN
  BEGIN
    DBMS_OUTPUT.PUT_LINE('IMPOSSIBLE !');
    RAISE_APPLICATION_ERROR(-20001, 'ON NE PEUT EMPRUNTER UN EXEMPLAIRE DEJA EMPRUNTE');
  END;
END;
/
```